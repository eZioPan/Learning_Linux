= Kea DHCP 服务器

历史悠久的 ISC DHCP（也就是 dhcpd）终于在 2022年12月走向了 EOL，于此同时 ISC 推出了 ISC DHCP 的替代软件 Kea DHCP

相较于 ISC DHCP，Kea DHCP 具有如下的新特性

* 模块化设计，Kea DHCP 的 IPv4 DHCP、IPv6 DHCP、DDNS 为三个独立的服务，而且可以动态地载入其它“钩子模块”来扩展功能。用户也可以方便地书写自己的 C++ 模块
* 通过 REST API 的在线重配置，Kea 在启动时读取一个 JSON 文件，在运行时，可以通过 set 命令修改，而不需要重启 DHCP 服务。
* 可与现有的系统集成，Kea 可以将数据从执行环境中分离，让部署有了更多选择。你的网络数据——lease、host reservation definitions、以及大多数配置——在使用一种 Kea 的“后端”之后，都可以与 DHCP fu服务器分开存放
* 基于网页的图形，Stork，可以用于以图标的形式查看多个 Kea 服务器

== 初次使用配置流程

[source, bash]
----
# 安装
dnf install kea
----

Kea 的 DHCPv4 服务器配置存储在 `/etc/kea/kea-dhcp4.conf`，其文件格式为带注释的 json 文件。 +
默认的文件有非常详细的注释，因此也很长，我们可以去 link:https://gitlab.isc.org/isc-projects/kea/-/blob/master/doc/examples/kea4/single-subnet.json[single-subnet.json] 看一看最简易的 DHCPv4 设置

[source, json]
.link:https://gitlab.isc.org/isc-projects/kea/-/blob/master/doc/examples/kea4/single-subnet.json[single-subnet.json]
----
// 在该配置中，我们启用了一个 Kea DHCPv4 服务器，
// 并配置了一个 IPv4 子网
// 而且包含了一个地址池，用于动态分配 IP 地址。
{
  // 对 DHCP4 进行配置
  "Dhcp4": {
    // 让服务器仅监听 eth0 接口
    // 若 interfaces 为空，则不开启 DHCP 服务器
    "interfaces-config": {
      "interfaces": ["eth0"]
    },

    // lease 数据库
    // 这里我们直接选用了内存文件 memfile 做演示
    // 因为它不需要预先的配置
    "lease-database": {
      "type": "memfile",
      "lfc-interval": 3600
    },

    // 地址具有的寿命为 4000 秒
    "valid-lifetime": 4000,

    // 刷新计时器和重绑计时器被注释掉了。
    // 这暗含了不会对客户端发送 option 58 和 option 59。
    // 此时，就由客户端依照 RFC2131 来选定计时器的值了。
    // 移除注释以向客户端发送这些 options。
    // "renew-timer": 1000,
    // "rebind-timer": 2000,

    // 下面的列表定义了子网。此处我们仅有一个子网。
    // 我们告诉 Kea，它在本地界面上直接可达。
    "subnet4": [
      {
        "pools": [{ "pool": "192.0.2.1 - 192.0.2.200" }],
        "subnet": "192.0.2.0/24",
        "interface": "eth0"
      }
    ],

    // 下面配置了日志。
    // 它假设最详细的信息界别（info, warn, error, fatal）应该被输出至标准输出。
    // 此处你也可以指定为标准错误，一个文件，或者 syslog，
    // 如果使用了 syslog，则会通过 syslog 存储输出的信息。
    "loggers": [
      {
        "name": "kea-dhcp4",
        "output_options": [
          {
            "output": "stdout"
          }
        ],
        "severity": "INFO"
      }
    ]
  }
}
----

上面的四配置为非常简易的配置，按照实际的网络状态修改以后，启动服务器，DHCP 服务就可以正常运行了。
实际上，`/etc/kea/kea-dhcp4.conf` 文件的默认内容会更加全面，注释也更加详细，参见 xref:80.1、kea-dhcp4.conf[]。

[source, bash]
.启动 Kea DHCPv4 服务器
----
# 启动 Kea DHCPv4 服务器
# 也可以通过 systemctl start kea-dhcp4
keactrl start -s dhcp4

# 查看 Kea 状态与配置文件信息
keactrl status
----
